# Level 2: Use-After-Free (UAF)

**éš¾åº¦**: â­â­ (åˆçº§)
**é¢„è®¡æ—¶é—´**: 3å°æ—¶
**å­¦ä¹ ç›®æ ‡**:
- ç†è§£ Use-After-Free æ¼æ´
- å­¦ä¹ å †é‡ç”¨æœºåˆ¶
- æŒæ¡ Dangling æŒ‡é’ˆåˆ©ç”¨

## ğŸ¯ æŒ‘æˆ˜ç›®æ ‡

é€šè¿‡ UAF æ¼æ´ï¼Œä¿®æ”¹å·²é‡Šæ”¾çš„ admin ç”¨æˆ·ç»“æ„ï¼Œä½¿ `admin->isAdmin = 0x1337`ã€‚

## ğŸ“‹ æŒ‘æˆ˜æè¿°

ç¨‹åºåˆ›å»ºäº†ä¸€ä¸ª admin ç”¨æˆ·ï¼ˆæœ‰æƒé™ï¼‰å’Œä¸€ä¸ªæ™®é€šç”¨æˆ·ã€‚ä½ éœ€è¦ï¼š
1. é‡Šæ”¾ admin ç”¨æˆ·
2. åˆ›å»ºæ–°ç”¨æˆ·ï¼ˆé‡ç”¨é‡Šæ”¾çš„å†…å­˜ï¼‰
3. é€šè¿‡æ–°ç”¨æˆ·æ§åˆ¶ admin çš„å†…å®¹
4. ä½¿ `admin->isAdmin = 0x1337` è·å– flag

## ğŸš€ å¿«é€Ÿå¼€å§‹

```bash
cd level02_uaf/challenge
make
make flag
./vuln
```

## ğŸ’¡ è§£é¢˜æ€è·¯

### UAF åŸç†

```c
User *admin = malloc(sizeof(User));
free(admin);           // é‡Šæ”¾å†…å­˜
                       // ä½† admin æŒ‡é’ˆä»æŒ‡å‘è¯¥åœ°å€ï¼
printf("%s", admin->username);  // â† UAF: ä½¿ç”¨å·²é‡Šæ”¾çš„å†…å­˜
```

### å †é‡ç”¨

```c
free(admin);           // é‡Šæ”¾ admin
user = malloc(sizeof(User));     // å¯èƒ½é‡ç”¨åŒä¸€å—å†…å­˜
// ç°åœ¨å†™å…¥ user ä¼šå½±å“ admin æŒ‡å‘çš„å†…å®¹ï¼
```

### åˆ©ç”¨æ­¥éª¤

1. **é€‰æ‹© 1**: é‡Šæ”¾ admin
2. **é€‰æ‹© 2**: ç¼–è¾‘ userï¼ˆä¼šé‡ç”¨ admin çš„å†…å­˜ï¼‰
   - Username: ä»»æ„ 31 å­—ç¬¦
   - Bio: è¿™é‡Œè¦æ„é€  isAdmin = 0x1337
3. **é€‰æ‹© 3**: æ‰“å° admin infoï¼ˆè§¦å‘ UAFï¼Œæ£€æŸ¥ isAdminï¼‰

### Payload æ„é€ 

User ç»“æ„ï¼š
```c
typedef struct {
    char username[32];  // åç§» 0
    char bio[64];       // åç§» 32
    int isAdmin;        // åç§» 96
} User;
```

éœ€è¦è®© bio çš„ç¬¬ 64 å­—èŠ‚å¤„ï¼ˆisAdmin å­—æ®µï¼‰ç­‰äº 0x1337ï¼š

```python
# bio å¡«å…… + isAdmin = 0x1337
bio = b"A" * 64 + p32(0x1337)
```

## ğŸ“š æŠ€æœ¯åŸç†

### UAF æ¼æ´

Use-After-Free æ˜¯æŒ‡ç¨‹åºä½¿ç”¨å·²é‡Šæ”¾çš„å†…å­˜ã€‚

**åŸå› **ï¼š
1. `free()` åæ²¡æœ‰å°†æŒ‡é’ˆç½® NULL
2. é‡Šæ”¾åé€šè¿‡åŸæŒ‡é’ˆè®¿é—®å†…å­˜
3. å †åˆ†é…å™¨å¯èƒ½é‡ç”¨è¯¥å†…å­˜

**å±é™©**ï¼š
- ä¿¡æ¯æ³„éœ²ï¼ˆè¯»å–é‡Šæ”¾çš„å†…å­˜ï¼‰
- æ•°æ®ç ´åï¼ˆå†™å…¥é‡Šæ”¾çš„å†…å­˜ï¼‰
- ä»£ç æ‰§è¡Œï¼ˆè¦†ç›–å‡½æ•°æŒ‡é’ˆç­‰ï¼‰

### Fastbin/Tcache è¡Œä¸º

- é‡Šæ”¾çš„å°å—ï¼ˆ< 128KBï¼‰è¿›å…¥ fastbin/tcache
- åç»­ malloc å¯èƒ½é‡ç”¨è¿™äº›å—
- é‡ç”¨æ—¶ä¼šè¦†ç›–åŸå†…å®¹

### å†…å­˜å¸ƒå±€

```
åˆå§‹:
  admin: [username(32)][bio(64)][isAdmin(4)]
  user:  [username(32)][bio(64)][isAdmin(4)]

free(admin) å:
  admin: [â†’ freed chunk]  â† admin æŒ‡é’ˆä»æŒ‡å‘è¿™é‡Œ
  user:  [username...]

malloc(user) åï¼ˆå¯èƒ½é‡ç”¨ admin çš„ä½ç½®ï¼‰:
  admin: [â†’ è¢« user é‡ç”¨]
  user:  [â†’ åŒä¸€å—å†…å­˜]
```

## ğŸ” è°ƒè¯•æŠ€å·§

### ä½¿ç”¨ GDB

```bash
gdb ./vuln
```

```
(gdb) break *main+XXX  # åœ¨ free å
(gdb) run
# é€‰æ‹© 1ï¼ˆfree adminï¼‰

# æŸ¥çœ‹ admin æŒ‡å‘çš„å†…å­˜
(gdb) x/30gx 0x5555...  # admin çš„åœ°å€

# é€‰æ‹© 2ï¼ˆç¼–è¾‘ userï¼‰
(gdb) x/30gx 0x5555...  # å†æ¬¡æŸ¥çœ‹ï¼Œåº”è¯¥çœ‹åˆ°å˜åŒ–
```

### ä½¿ç”¨ Pwndbg

```
(gdb) heap               # æŸ¥çœ‹å †å¸ƒå±€
(gdb) fastbins           # æŸ¥çœ‹ fastbins
(gdb) heap_chunk <addr>  # æŸ¥çœ‹ç‰¹å®š chunk
```

## ğŸ“ è¿›é˜¶æŒ‘æˆ˜

1. **ä¿¡æ¯æ³„éœ²**ï¼šåˆ©ç”¨ UAF è¯»å–é‡Šæ”¾å†…å­˜ä¸­çš„æ•æ„Ÿæ•°æ®
2. **ç±»å‹æ··æ·†**ï¼šé€šè¿‡ UAF æ”¹å˜å¯¹è±¡çš„è§£é‡Šæ–¹å¼
3. **å‡½æ•°æŒ‡é’ˆåŠ«æŒ**ï¼šåˆ©ç”¨ UAF è¦†ç›–è™šå‡½æ•°æŒ‡é’ˆ

## ğŸ“– é˜…è¯»ææ–™

- [UAF æ”»å‡»è¯¦è§£](https://owasp.org/www-community/vulnerabilities/Use_after_free)
- [Level 2 ç†è®ºæ–‡æ¡£](docs/theory.md)
- [Level 2 Walkthrough](docs/walkthrough.md)

## ä¸‹ä¸€æ­¥

å®Œæˆ Level 2 åï¼Œç»§ç»­ **[Level 3: Fastbin Double Free](../level03_fastbin_dup/)**ï¼

---

**ç¥ä½ æŒ‘æˆ˜æˆåŠŸï¼** ğŸ’ª
