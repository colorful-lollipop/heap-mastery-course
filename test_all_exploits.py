#!/usr/bin/env python3
"""
è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬ - æµ‹è¯•æ‰€æœ‰levelçš„exploits
"""

import subprocess
import os
import sys
from pathlib import Path

# Levelé…ç½®
LEVELS = {
    0: {"name": "Environment Check", "path": "level00_setup"},
    1: {"name": "Heap Overflow", "path": "level01_overflow"},
    2: {"name": "UAF", "path": "level02_uaf"},
    3: {"name": "Fastbin Dup", "path": "level03_fastbin_dup"},
    4: {"name": "Tcache Poisoning", "path": "level04_tcache"},
    5: {"name": "Heap Spraying", "path": "level05_heap_spray"},
    6: {"name": "Heap Feng Shui", "path": "level06_feng_shui"},
    7: {"name": "Advanced", "path": "level07_advanced"},
}

def run_command(cmd, cwd=None, timeout=30):
    """è¿è¡Œå‘½ä»¤å¹¶è¿”å›žç»“æžœ"""
    try:
        result = subprocess.run(
            cmd,
            shell=True,
            cwd=cwd,
            capture_output=True,
            text=True,
            timeout=timeout
        )
        return result.returncode, result.stdout, result.stderr
    except subprocess.TimeoutExpired:
        return -1, "", "Timeout"

def build_level(level_num):
    """ç¼–è¯‘æŒ‡å®šlevel"""
    level = LEVELS[level_num]
    path = f"/root/code/safe/{level['path']}/challenge"

    print(f"  [*] Building Level {level_num}: {level['name']}...")

    # åˆ›å»ºflag.txt
    flag_file = f"{path}/flag.txt"
    if not os.path.exists(flag_file):
        with open(flag_file, 'w') as f:
            f.write(f"flag{{level{level_num}_test_flag}}\n")

    # ç¼–è¯‘
    ret, stdout, stderr = run_command("make clean && make", cwd=path)
    if ret != 0:
        print(f"  [âœ—] Build failed!")
        print(stderr)
        return False

    print(f"  [âœ“] Build successful")
    return True

def test_level(level_num):
    """æµ‹è¯•æŒ‡å®šlevelçš„exploit"""
    level = LEVELS[level_num]
    path = f"/root/code/safe/{level['path']}"

    print(f"\n{'='*60}")
    print(f"Testing Level {level_num}: {level['name']}")
    print(f"{'='*60}")

    # Level 0ç‰¹æ®Šå¤„ç†
    if level_num == 0:
        ret, stdout, stderr = run_command("./check_env", cwd=path)
        if ret == 0:
            print(f"  [âœ“] Level {level_num} PASSED")
            return True
        else:
            print(f"  [âœ—] Level {level_num} FAILED")
            return False

    # æŸ¥æ‰¾exploitæ–‡ä»¶
    exploit_paths = [
        f"{path}/solution/exploit_solution.py",
        f"{path}/solution/exploit.py",
        f"{path}/exploit_solution.py",
    ]

    exploit_path = None
    for ep in exploit_paths:
        if os.path.exists(ep):
            exploit_path = ep
            break

    if not exploit_path:
        print(f"  [!] No exploit found for Level {level_num}")
        return None

    print(f"  [*] Running exploit: {exploit_path}")

    # å¤åˆ¶åˆ°challengeç›®å½•
    challenge_path = f"{path}/challenge"
    exploit_name = os.path.basename(exploit_path)
    dest_path = f"{challenge_path}/{exploit_name}"

    # å¦‚æžœexploitåœ¨solutionç›®å½•ï¼Œéœ€è¦è°ƒæ•´è·¯å¾„
    if "solution" in exploit_path:
        # ä¿®æ”¹exploitä¸­çš„processè·¯å¾„
        with open(exploit_path, 'r') as f:
            content = f.read()

        # å°†è·¯å¾„æ”¹ä¸º./vuln
        content = content.replace("process('/root/code/safe/build", "process('./")
        content = content.replace("process('/root/code/safe/", "process('../")

        with open(dest_path, 'w') as f:
            f.write(content)

        run_exploit_path = dest_path
    else:
        run_exploit_path = exploit_path

    # è¿è¡Œexploit
    ret, stdout, stderr = run_command(
        f"python3 {exploit_name}",
        cwd=challenge_path,
        timeout=60
    )

    # æ£€æŸ¥ç»“æžœ
    success_indicators = [
        "Flag:",
        "ðŸŽ‰",
        "ðŸŽ¯",
        "Congratulations",
        "Success",
        "PASSED",
        "success"
    ]

    success = any(indicator in stdout for indicator in success_indicators)

    if success:
        print(f"  [âœ“] Level {level_num} PASSED")
        return True
    else:
        print(f"  [âœ—] Level {level_num} FAILED")
        if stdout:
            print(f"  Output: {stdout[:200]}")
        return False

def main():
    print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
    print("â•‘     Heap Mastery Course - Automated Test Suite          â•‘")
    print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")

    results = {}

    # é€‰æ‹©è¦æµ‹è¯•çš„level
    if len(sys.argv) > 1:
        levels_to_test = [int(arg) for arg in sys.argv[1:]]
    else:
        levels_to_test = list(LEVELS.keys())

    # æµ‹è¯•æ¯ä¸ªlevel
    for level_num in levels_to_test:
        try:
            # ç¼–è¯‘
            if not build_level(level_num):
                results[level_num] = "BUILD_FAILED"
                continue

            # æµ‹è¯•
            result = test_level(level_num)
            if result is None:
                results[level_num] = "NO_EXPLOIT"
            elif result:
                results[level_num] = "PASSED"
            else:
                results[level_num] = "FAILED"

        except Exception as e:
            print(f"  [âœ—] Error: {e}")
            results[level_num] = "ERROR"

    # æ‰“å°æ€»ç»“
    print(f"\n{'='*60}")
    print("Test Summary")
    print(f"{'='*60}")

    passed = sum(1 for r in results.values() if r == "PASSED")
    failed = sum(1 for r in results.values() if r in ["FAILED", "BUILD_FAILED", "ERROR"])
    skipped = sum(1 for r in results.values() if r == "NO_EXPLOIT")
    total = len(results)

    print(f"\nTotal: {total} | Passed: {passed} | Failed: {failed} | No Exploit: {skipped}")

    print("\nDetailed Results:")
    for level_num in sorted(results.keys()):
        status = results[level_num]
        level_name = LEVELS[level_num]["name"]

        if status == "PASSED":
            symbol = "âœ“"
        elif status == "NO_EXPLOIT":
            symbol = "âŠ˜"
        else:
            symbol = "âœ—"

        print(f"  [{symbol}] Level {level_num}: {level_name} - {status}")

    print(f"\n{'='*60}")

    # è¿”å›žé€€å‡ºç 
    if failed > 0:
        sys.exit(1)
    else:
        sys.exit(0)

if __name__ == "__main__":
    main()
